# 第六章

## DNS协议(域名系统 Domain Name System)（重点）

### 域名解析协议的概述
    1. DNS的作用
        负责解析域名,将域名解析成IP地址

    2. 概念:
        <1> 域名:互联网上的网站或者服务器的名称就叫做域名,域名都是以点开始的,这就是根,然后就是顶级域名(com,edu,net,
                  cn,org,gow)。域名都是全球唯一的(二级域名先申请先得到,但是可以向他人购买)
            
            * 根:.

            * 顶级域名:
                com:具有商业性质
                edu:具有教育性质
                net:提供信息的服务器
                cn:代表是中国的
                org:代表组织
                gov:代表政府部门
                
            * 二级域名:(全球唯一)
                个人申请:如baidu,heima等
            * 三级域名:如:www.dba.baidu.com

            * 举例:假如www.baidu.com(万维网),mail.baidu.com(邮件服务器),ftp.baidu.com(ftp服务器) 也是说在baidu下
                    有三个服务器,而这三个服务器不需要再购买,我们只需要购买域名即可,加上了www或者mail或者ftp等,这个域
                    名就叫做完全限定域名(FQDN)
            
            * DNS服务器:8.8.8.8(谷歌公司的DNS服务器),222.222.222是电信公司DNS服务器

            * 域名解析:
                ping www.baidu.com
                nslookup www.baidu.com

    3.域名服务器：
        根域名服务器: 下面保存了各个顶级域名服务器的IP地址
        顶级域名服务器: 每一个顶级域名服务器都保存了其下的权限域名服务器的IP地址
        权限域名服务器: 如果是二级域名分成两个区, 则该每个区对应一个权限域名服务器(如a.com分成两个区
                      a.com和b.a.com)每一个区中保存了其底下的三级域名等的IP地址
        本地域名服务器：每一个网络服务提供商ISP, 每一个大学, 甚至大学里的一个系都会有一个本地域名服务器,也叫默认域
                       名服务器

    4. 高速缓存：对于已经访问的域名，该域名的IP地址会保存在本地域名服务器的高速缓存中, 同样的, 在其它域名服务器中也会
                存在已经访问过的域名的缓存。并且在主机也存在高速缓存, 有时候在开机的时候主机会从本地域名服务器中下载
                缓存的域名信息
    
    5. 什么时候需要自定义的DNS服务器
        1. 解析内网自己的域名
        2. 降低到Internet的域名解析流量
        3. 域环境


### 域名解析的过程
    1. 详细解析过程如下所示
        * 通过下列8个步骤客户端可以顺利解析www.136.com这个域名

<img src="./image/img23.png" width = 800px>

    2. 两种查询方式
        <1> 递归查询
            * 当DNS服务器接受到客户端查询请求时，会使用一个准确的查询结果返回给客户端。如果DNS服务器没有存储需要查询
              的信息，那么该服务器就会询问其他DNS服务器，并将返回的结果提交给客户端

        <2> 迭代查询
            * 当客户端发送查询请求时，DNS服务器不会直接回复查询结果，而是告诉客户机另外一台DNS服务器的地址，客户机再
              向这台DNS服务器提交请求，循环如此，直到找到结果

        <3> 一般从PC客户端到本地DNS服务器是递归查询，而DNS服务器之间就是交互的迭代查询

    3. 正向解析与反向解析
        <1> 正向解析:域名到IP的解析过程

        <2> 反向解析:从IP地址到域名的解析过程。反向解析的作用是服务器的身份验证

### DNS中的资源记录
    1. SOA资源记录
        每个区在区的开始处都包含了一个起始授权记录(Start of Authority Record) ,简称SOA记录。SOA定义了域的全局参数,进
        行整个域的管理设置。一个区域文件只允许存在唯一的 SOA记录。

    2. NS资源记录
        NS (Name Server)记录是域名服务器记录,用来指定该域名由哪个DNS服务器来进行解析。每个区在区根处至少包含1个NS记录。
         
    3. A资源记录
        地址(A)资源记录把FQDN映射到IP地址。因为有此记录,所以DNS服务器能解析FQDN域名对应的IP地址。

    4. PTR资源记录
        相对于A资源记录,指针( PTR )记录把IP地址映射到FQDN。用于反向查询 ，通过IP地址,找到域名

    5. CNAME资源记录
        别名记录( CNAME )资源记录创建特定FQDN的别名。用户可以使用CNAME记录来隐藏用户网络的实现细节,使连接的客户机无法
        知道真正的域名

## DHCP(动态主机配置协议)

### DHCP概述
    1. 概述
        * 静态ip地址（计算机比较固定时，或者服务器，可以使用）
        * 动态ip地址(自动获取ip地址)
        * 注意：在IP配置中，如果使用自动获得地址就是动态地址，如果选择使用下面的地址（自定义的地址）则是静态地址


## DHCP详细解析
    1. 使用DHCP协议的原因
        <1> 当我们需要上网时，需要有IP地址，需要配置子网掩码，DNS等等，那么问题来了，如果说有大量计算机的话，那么手动
            配置这些就不现实，所以需要动态主机配置

    2. 相关概念
        <1> DHCP是一个局域网协议，不能跨网段，需要使用中继设备(路由器等)

        <2> DHCP服务器：含有DHCP协议的计算机

    3. DHCP原理
        <1> DHCP客户端请求IP地址的过程
            
            网络中有多个DHCP服务器,当计算机设置为IP自动获得，这就变成了DHCP客户端，然后发送广播请求DHCP服务器，当服
            务器（多个） 收到请求后就会将IP地址给计算机，计算机会向其中一个服务器发送确认，选择使用，而其他的则收回，
            继续给其他计算机使用。

            注意：这是一个没有认证的过程，如果分配到错误的IP就不能正常使用。DHCP服务器必须使用静态地址
                 使用DHCP获得IP地址后，释放IP地址：ipconfig release
                 请求地址：ipcondig renew

<img src="./image/img28.png" width = 800px>

        <2> DHCP客户端续租地址的过程
            首先客户端会在租期还有50%-87.5%之间的时候，发送一个续租请求(单播)，如果在租期消耗到87.5%之前，原来的
            DHCP服务器发了一个ACK确认续租的话，那么租期会从计时。如果在租期消耗到87.5%之前没有得到回复，此时，客户
            端会发送广播消息(请求地址)，如果在消耗所有之前的租期还有其他服务器分配地址的话，此时客户端就会向客户端
            上交原来地址

        <3> 跨网段地址分配(中继)
            不同网段的地址分配，需要在DHCP服务器上创建作用域，DHCP服务器本网段的计算机发送请求地址，服务器直接收到，
            而跨网段的计算机请求地址,则需要先通过路由器。配置DHCP中继代理时是在需要请求的计算机的路由器进行配置。(配
            置路由器：ip help-address ip地址)

<img src="./image/img29.png" width = 800px>
        
### DHCP的安全威胁
    1. 饿死攻击
        <1> 概念：持续大量申请IP地址，导致DHCP服务器的地址耗尽

        <2> 产生：利用软件不停的向DHCP服务器发送不同chadder值(根据chadder值来判断是否申请IP地址)，来请求IP地址

    2. 仿冒服务器攻击
        <1> 实际体现：当我们将一个路由器插在交换机上时，整个办公室的电脑不能上网
            * 解析：
                这是因为路由器默认是开启DHCP服务的，连接上之后相当于一个DHCP服务器，当电脑请求上网时，首先回应的
                是路由器的DHCP(先到先得)，而真正的DHCP服务器(由于后到)所以，客户机在广播使用的IP时，指定的是路由
                器的非法ip，而不是合法分配的ip
            
            * 同样主机如果安装DHCP服务器的话，也可能导致这个结果

    3. 中间人攻击
        <1> 其实就是arp欺骗。攻击者将arp表(MAC地址与IP地址的映射表)修改。

## FTP（文件传输协议）
    1. 概述（FTP使用两个TCP连接）
        <1> FTP连接方式
            * 主动模式：FTP客户端告诉FTP服务器使用什么端口侦听，FTP服务器和FTP客户端的这个端口建立连接，源端口为20。
                        （服务端从20端口主动向客户端发起连接）       

                 * 注意：TCP控制连接使用的是TCP的21端口，用于发送命令（上传，下载等）。TCP数据连接使用的是TCP的20端口，
                         用于数据传输。

            * 被动模式：FTP服务器被动的打开一个端口，等待FTP客户端来连接。（服务端再指定范围内的某个端口被动等待客户端
                        发起连接）

<img src="./image/FTP/img01.png" width = 800px>

        <2> FTP传输模式
            * 文本模式：ASCII模式，以文本序列传输数据
            * 二进制模式：Binary模式，以二进制序列传输数据

            * 主动模式下，防火墙需要打开20和21端口
            * 被动模式下，防火墙只打开20和21端口FTP不能下载数据（因为被动模式下，FTP服务器的等待连接端口是随意指定的）
            * 总而言之，FTP服务器端，如果有防火墙，需要在防火墙打开20和21端口，使用主动模式进行数据连接
    
    2. 如何在windows上安装FTP服务
        win10系统FTP服务器架设:
            <1> 控制面板 => 程序 => 启动或关闭windows功能 => Intenet Information Service=> 选中FTP服务器以及Web管理
                工具中的ISS管理控制台

            <2> 控制面板 => 系统和安全 => 管理工具 => Internet Information Services (IIS)管理器 => GOOT下的网站 => 
                添加FTP站点

            <3> windows防火墙 => 允许应用 => 选中FTP服务器 =>  在盘符下输入 C:\Windows\System32\svchost 或者
                ftp：//ftp的ip地址

            <4> 此时客户端即可连接, 如果客户端选择了FTP主动模式(IE浏览器=>Intenet选项=>高级=>不勾选被动FTP),那么客户端
                在连接FTP时会弹出防火墙已经阻止资源管理器打开FTP的功能(即用文件夹的方式打开不了), 此时应该选择允许, 如果
                忘记选了是登陆不上的, 需要在防火墙的允许应用通过中勾选Windows资源管理器

    3. Linux环境下安装vsftpd
        <1> 使用 yum -y install vsftpd 即可安装

        <2> 配置文件解析
            /var/ftp/pub/                   默认的共享目录
            /etc/vsftpd/vsftpd.conf         vsftpd主配置文件
            /etc/vsftpd/ftpusers            用户指定哪些用户不能访问ftp服务器,黑名单
            /etc/vsftpd/user_ list          用户指定哪些用户能访问ftp服务器,白名单
            /var/ftp/                       默认情况下匿名用户的根目录

        <3> 启动服务
            service vsftpd restart


## telnet（远程终端协议）
    1.概述：
        端口默认使用23

        linux系统tenet连接使用：
            <1> telnet IP地址（前提能够ping通）
            <2> 登录路由器(输入用户名和密码) => show interface  
        
        windows系统tenet连接使用:
            <1> 启用telnet服务（在控制面板中个启动或关闭windows功能下）

        注意：
            cmd命令：<1> 重设密码 net user administrator 用户密码
                    <2> 添加用户 net user 用户名 用户密码 /add
                    <3> 将用户加入管理员组: net localgroup administrators 用户 /add
                    <4> 测试IP地址的端口是否打开： telnet IP地址 端口号

## RDP（远程桌面协议）
    1.概述
        * 服务：mstsc 使用TCP的3389端口
        * Server多用户操作系统，启用远程桌面可以多用户同时操作服务器
        * XP和windows7 单用户操作系统 不支持多用户同时操作
    
    2.如何将本地的硬盘映射到远程计算机
        * 在远程连接页面时，先通过选项将所需要映射的内容选中（可用于计算机之间拷贝文件等）


## HTTP协议（超文本传输协议）

### HTTP的综合
    1.概述
        * 万维网（world wide web）：之所以叫做万维网是因为访问网站时，可以通过统一资源定位符（URL）转到其他网站，网站
                                   之间相互连通。

        * 与万维网相关的概念：
            * 客户服务器方式（C/S）：
            * 客户程序
            * 浏览器：如谷歌浏览器等
            * 服务器程序：如windows2003（可以安装IIS服务：互联网信息服务）
            * 万维网服务器：运行网站的硬件
            * 页面：一个网站有多由多个页面组成
            * 统一资源定位符（URL）:
                    url的一般形式：<协议>://<主机>:<端口>/路径
                    网站的标识：可以使用不同的端口号区分，也可以使用不同的IP地址区分，使用域名区分（最佳方法，可以实现
                                一个服务器多个网站）
            * HTTP使用TCP连接
            * 超文本标记语言HTML
            * 搜索引擎
    2. 如何在计算机上安装web服务，创建web站点
        <1> 在控制面板 => 程序 => 启动和关闭windows服务 => 万维网服务
        <2> 系统和安全 => 管理工具 => 服务中查找
        <3> 系统和安全 => 管理工具 => IIS => 网站 => 添加网站

    3.使用web代理服务器访问网站
        1.节省内网访问Internet的带宽
        2.通过代理绕过防火墙
        3.通过Web代理可以绕过跟踪

### HTTP协议详解
    1. 概述
        <1> HTTP协议是基于TCP协议的，默认端口是80，是一个可靠的协议

        <2> 功能：规定客户端与服务端的数据传输格式

        <3> 特点：基于请求与响应模式的，无状态，无连接的应用层协议

    2. HTTP的请求与响应
        <1> HTTP的请求(由请求行，请求头，空行，请求体组成)
            1) 请求行(请求方法 + URL + 版本信息)
                * 请求方法如下所示

<img src="./image/img19.png" width = 800px>

            2) 请求头(常见如下)

<img src="./image/img20.png" width = 800px>

        <2> HTTP的响应(由响应行，响应头，空行，响应体组成)
            1) 响应行(HTTP版本 + HTTP状态码 + 原因(状态码))
                * 状态码如下所示

<img src="./image/img21.png" width = 800px>

            2) 响应头(常见如下)

<img src="./image/img22.png" width = 800px>


    3. 抓包分析HTTP
        <1> 请求报文分析

<img src="./image/img17.png" width = 800px>

        <2> 响应报文分析

<img src="./image/img18.png" width = 800px>

    4. 如何理解HTTP是一个无连接的应用层协议？
        <1> 限制了每次连接只处理一个请求，服务器处理完客户请求，并收到客户的应答后，就会断开连接

        <2> 这样设置的初衷：
            * 如果有大量用户请求页面，那么会导致单个用户的间歇大(突发性，瞬时性)，从而导致数据没有关联性，那么就会导
              致资源的浪费，所以就释放连接

            * 那么，这又导致一个问题：如果网页复杂，会导致请求响应效率低下，我们可以设置keep-alive解决

        <3> keep-alive的设置
            1) 开启：Connection:keep-alive,会发起keep-alive的连接请求--长连接。http1.1默认打开(不需要重新建立连接)

            2) 关闭：在响应头中设置Connection:close，即可关闭

            3) 设置连接时间
                在http的响应头中设置keep-alive:timeout=5,max=1000
                    * timeout是指超时时间，单位为秒，超过这个时间就断开连接
                    * max是最多连接次数，若超过次数就断开连接

    5. 如何理解HTTP是一个无状态的应用层协议
        <1> 对事务处理没有记忆能力，服务器不知道客户端是什么状态，给服务器发送http请求之后，服务器回应之后，不会有任何
            记录，每个请求都是独立的。

        <2> 那么，服务器在处理后续请求时，那么前面请求的信息可能需要重传。优点：释放服务器的压力。缺点：需要重传，增大
            数据量，浪费资源

        <3> 所以我们就需要使用Cookies和Session解决
            1) Cookies：将前面请求的信息保存成一个临时文件(Cookies值)，存放在浏览器中。只要关闭浏览器就会被清除

            2) Session：永久的Cookies值。保存在服务器上，传递给客户端，会保存在内存中

    6. HTTP协议存在问题
        * http发送的数据都是明文，可能导致请求或响应信息被篡改，监听等

## 电子邮件（SMTP，POP3,IMAP）
    1. 概述：
        * SMTP:简单邮件传输协议，用于发送电子邮件
        * POP3：用于接受电子邮件
        * IMAP:用于接受电子邮件

        * 邮件发送的过程
            首先邮件客户端（如foxmail）需要将邮件发送到邮件服务器（利用SMTP协议），然后服务器将邮件发送到接收方的邮件
            服务器的收件箱（利用SMTP协议），最后接收方再从自己的邮件服务器中接收邮件（利用POP3或者IMAP）

            注意：第一个发送过程的实现叫做邮件的中继。其中中继过程和接收邮件的过程都需要身份验证

